# Goose 프로젝트 구조

이 문서는 goose 프로젝트의 전체 구조를 상세히 설명합니다.

## 개요

goose는 엔지니어링 작업을 자동화하는 로컬 AI 에이전트입니다. Rust로 작성된 백엔드와 Electron 기반의 TypeScript 데스크톱 UI로 구성되어 있습니다. Model Context Protocol(MCP)을 통해 도구를 실행합니다.

## 최상위 디렉토리 구조

```
goose/
├── crates/                 # Rust 크레이트 (핵심 로직)
├── ui/                     # 사용자 인터페이스
│   └── desktop/            # Electron 데스크톱 앱
├── documentation/          # Docusaurus 문서 사이트
├── scripts/                # 빌드 및 유틸리티 스크립트
├── examples/               # 예제 코드
├── bin/                    # Hermit 환경 관리
├── clippy-baselines/       # Clippy 린트 베이스라인
├── recipe-scanner/         # 레시피 스캐너 도구
├── .github/                # GitHub Actions 워크플로우
├── .devcontainer/          # 개발 컨테이너 설정
├── Cargo.toml              # Rust 워크스페이스 설정
├── Justfile                # 빌드 자동화 명령어
└── 기타 설정 파일들
```

## Crates 디렉토리 (Rust 크레이트)

### goose (핵심 엔진)
경로: `crates/goose/`

에이전트의 핵심 로직이 담긴 메인 크레이트입니다.

```
crates/goose/src/
├── agents/                 # 에이전트 오케스트레이션
│   ├── agent.rs            # 메인 에이전트 구현 (81KB)
│   ├── mcp_client.rs       # MCP 클라이언트 통합
│   └── ...
├── providers/              # LLM 프로바이더 구현
│   ├── base.rs             # Provider 트레이트 정의
│   ├── anthropic.rs        # Anthropic Claude
│   ├── openai.rs           # OpenAI GPT
│   ├── azure.rs            # Azure OpenAI
│   ├── google.rs           # Google Gemini
│   ├── bedrock.rs          # AWS Bedrock
│   ├── gcpvertexai.rs      # GCP Vertex AI
│   ├── ollama.rs           # Ollama 로컬 모델
│   ├── openrouter.rs       # OpenRouter
│   ├── databricks.rs       # Databricks
│   ├── litellm.rs          # LiteLLM
│   ├── snowflake.rs        # Snowflake
│   ├── venice.rs           # Venice
│   ├── xai.rs              # xAI Grok
│   ├── githubcopilot.rs    # GitHub Copilot
│   ├── cursor_agent.rs     # Cursor IDE
│   └── ...
├── config/                 # 설정 관리
├── session/                # 세션 상태 관리
├── conversation/           # 대화 메시지 처리
├── permission/             # 권한 관리
├── security/               # 보안 검사
├── recipe/                 # 레시피/워크플로우 정의
├── prompts/                # 프롬프트 템플릿
├── context_mgmt/           # 컨텍스트 관리
├── execution/              # 실행 관리
├── hints/                  # 힌트 시스템
├── oauth/                  # OAuth 인증
├── tracing/                # 트레이싱/로깅
├── scheduler.rs            # 작업 스케줄링
├── model.rs                # 모델 정의
├── token_counter.rs        # 토큰 카운팅
├── tool_inspection.rs      # 도구 검사
└── lib.rs                  # 라이브러리 진입점
```

### goose-cli (커맨드 라인 인터페이스)
경로: `crates/goose-cli/`

CLI 애플리케이션을 제공합니다.

```
crates/goose-cli/src/
├── main.rs                 # CLI 진입점
├── cli.rs                  # clap 기반 인자 파싱 (53KB)
├── commands/               # 개별 명령어 구현
├── session/                # CLI 세션 처리
└── scenario_tests/         # 통합 테스트 시나리오
```

### goose-server (백엔드 서버)
경로: `crates/goose-server/`

데스크톱 앱을 위한 REST API 백엔드입니다. 바이너리 이름은 `goosed`입니다.

```
crates/goose-server/src/
├── main.rs                 # 서버 진입점
├── routes/                 # REST API 엔드포인트
├── openapi.rs              # OpenAPI 스키마 생성
└── state.rs                # 서버 상태 관리
```

### goose-mcp (MCP 확장)
경로: `crates/goose-mcp/`

내장 MCP 서버들을 제공합니다.

```
crates/goose-mcp/src/
├── developer/              # 개발자 도구 (쉘, 파일 작업)
├── computercontroller/     # 화면/입력 자동화
├── autovisualiser/         # 시각화 도구
├── memory/                 # 메모리/지식 관리
├── tutorial/               # 튜토리얼 도구
├── lib.rs                  # 라이브러리 진입점
└── mcp_server_runner.rs    # MCP 서버 실행기
```

### 기타 크레이트

- **goose-bench**: 벤치마킹 도구
- **goose-test**: 테스트 유틸리티
- **goose-acp**: 추가 컨텍스트 프로토콜

## UI 디렉토리 (Electron 앱)

경로: `ui/desktop/`

TypeScript + React로 작성된 Electron 데스크톱 애플리케이션입니다.

```
ui/desktop/
├── src/
│   ├── main.ts             # Electron 메인 프로세스 (79KB)
│   ├── preload.ts          # 프리로드 스크립트
│   ├── renderer.tsx        # React 렌더러 진입점
│   ├── App.tsx             # 메인 앱 컴포넌트
│   ├── api/                # 자동 생성된 API 클라이언트
│   ├── components/         # React 컴포넌트
│   ├── contexts/           # React 컨텍스트
│   ├── hooks/              # 커스텀 훅
│   ├── store/              # 상태 관리
│   ├── styles/             # 스타일 파일
│   ├── types/              # TypeScript 타입 정의
│   ├── utils/              # 유틸리티 함수
│   ├── platform/           # 플랫폼별 코드
│   ├── recipe/             # 레시피 관련
│   ├── bin/                # 번들된 바이너리
│   ├── images/             # 이미지 리소스
│   ├── assets/             # 기타 에셋
│   ├── constants/          # 상수 정의
│   ├── goosed.ts           # goosed 서버 관리
│   ├── sessions.ts         # 세션 관리
│   ├── schedule.ts         # 스케줄링
│   └── test/               # 테스트 파일
├── openapi.json            # OpenAPI 스키마 (자동 생성)
├── package.json            # npm 설정
├── tsconfig.json           # TypeScript 설정
├── vite.config.ts          # Vite 빌드 설정
└── vitest.config.ts        # Vitest 테스트 설정
```

## 주요 설정 파일

### Cargo.toml (워크스페이스)
```toml
[workspace]
members = ["crates/*"]

[workspace.package]
version = "1.21.0"
edition = "2021"
```

### Justfile
빌드 자동화를 위한 명령어 모음:
- `just release-binary`: 릴리스 빌드 + OpenAPI 생성
- `just run-ui`: UI 빌드 및 실행
- `just generate-openapi`: OpenAPI 스키마 생성
- `just check-everything`: 전체 스타일 체크

### rust-toolchain.toml
Rust 버전 고정 설정

### Hermit 환경 (bin/)
일관된 개발 환경 제공:
- Rust 1.28.2
- Node 24.10.0
- Just 1.40.0
- Protoc 31.1

## 아키텍처 개요

### 3계층 아키텍처

```
┌─────────────────────────────────────────────────────────┐
│                    인터페이스 계층                        │
│                                                         │
│     ┌─────────────────┐      ┌─────────────────┐       │
│     │   Desktop UI    │      │      CLI        │       │
│     │   (Electron)    │      │   (goose-cli)   │       │
│     └────────┬────────┘      └────────┬────────┘       │
└──────────────┼────────────────────────┼─────────────────┘
               │ REST API               │ 직접 호출
               ▼                        ▼
┌─────────────────────────────────────────────────────────┐
│                     에이전트 핵심                        │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │                  goose-server                     │  │
│  │                   (goosed)                        │  │
│  └──────────────────────────────────────────────────┘  │
│                          │                              │
│  ┌──────────────────────────────────────────────────┐  │
│  │                    goose                          │  │
│  │  ┌─────────┐ ┌──────────┐ ┌─────────────────┐   │  │
│  │  │ Agents  │ │ Providers│ │    Sessions     │   │  │
│  │  └─────────┘ └──────────┘ └─────────────────┘   │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
               │
               ▼ MCP Protocol
┌─────────────────────────────────────────────────────────┐
│                     확장 계층                            │
│                                                         │
│   ┌──────────┐  ┌───────────────┐  ┌──────────────┐   │
│   │Developer │  │ComputerControl│  │   Memory     │   │
│   │  Tools   │  │     ler       │  │              │   │
│   └──────────┘  └───────────────┘  └──────────────┘   │
│                                                         │
│            + 외부 MCP 서버 확장                          │
└─────────────────────────────────────────────────────────┘
```

### 에이전트 실행 루프

1. **사용자 요청** → 사용자 입력 수신
2. **프로바이더 채팅** → 사용 가능한 도구와 함께 LLM에 전송
3. **도구 호출** → LLM이 도구 호출 생성 (JSON 형식)
4. **도구 실행** → goose가 도구 실행 및 결과 수집
5. **모델 응답** → 도구 결과를 LLM에 전송
6. **컨텍스트 수정** → 토큰 효율성을 위해 대화 요약/압축
7. **최종 응답** → LLM이 사용자에게 최종 응답 생성

### 에러 처리 전략

| 에러 유형 | 처리 방식 | 사용 타입 |
|----------|----------|----------|
| 전통적 에러 (네트워크, API 실패) | 예외 발생 | `anyhow::Error` |
| 에이전트 에러 (잘못된 도구, 실행 실패) | LLM에 결과로 전송 (복구 가능) | `thiserror::Error` |

## 개발 워크플로우

### 환경 설정
```bash
source bin/activate-hermit
```

### 빌드 및 테스트
```bash
cargo build                    # 디버그 빌드
cargo build --release          # 릴리스 빌드
cargo test                     # 전체 테스트
cargo test -p goose            # 특정 크레이트 테스트
```

### 린트 및 포맷
```bash
cargo fmt                      # 코드 포맷팅
./scripts/clippy-lint.sh       # 전체 린트 검사
```

### UI 개발
```bash
just generate-openapi          # 서버 변경 후 실행
just run-ui                    # 릴리스 빌드 + UI 실행
just debug-ui                  # 외부 백엔드 모드로 UI 실행
```

### 서버 기능 추가 시
1. `goose-server/src/routes/`에 라우트 추가
2. `just generate-openapi` 실행
3. `ui/desktop/src/api/`에 자동 생성된 클라이언트 사용

## 주요 진입점

| 컴포넌트 | 파일 경로 |
|---------|----------|
| CLI 진입점 | `crates/goose-cli/src/main.rs` |
| 서버 진입점 | `crates/goose-server/src/main.rs` |
| 에이전트 핵심 | `crates/goose/src/agents/agent.rs` |
| UI 진입점 | `ui/desktop/src/main.ts` |
| 프로바이더 기본 | `crates/goose/src/providers/base.rs` |

## CI/CD 파이프라인

GitHub Actions (`.github/workflows/ci.yml`)에서 실행:

| 체크 항목 | 명령어 |
|----------|--------|
| Rust 포맷팅 | `cargo fmt --check` |
| Rust 테스트 | `cargo test --jobs 2` |
| Rust 린트 | `./scripts/clippy-lint.sh` |
| OpenAPI 검증 | `just check-openapi-schema` |
| UI 린트 | `npm run lint:check` |
| UI 테스트 | `npm run test:run` |

## 보안 고려사항

- goose는 쉘 명령어와 파일 시스템에 접근 가능
- 코드를 자율적으로 실행 (높은 위험)
- 프롬프트 인젝션에 취약
- 격리된 환경(VM/컨테이너)에서 실행 권장
- 민감한 파일은 `.gooseignore`로 보호
